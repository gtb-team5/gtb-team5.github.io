<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>GIJIGORIのメインページだよ！</title>
        <script src = "https://www.gstatic.com/firebasejs/5.8.4/firebase-app.js"></script>
        <script src = "https://www.gstatic.com/firebasejs/5.8.4/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase-database.js"></script>
        <script src="https://unpkg.com/vue"></script>
        <script>

            //------------------------------------議事録やユーザーに関する変数やfirebaseへの参照用変数---------------
            //ユーザーに関する定義と参照
            var uid= null;
            var memberRef = null;


            //----下は議事録が変更された時同時に変更を必ず行わないといけない,DBと参照とその表記メソッド
            //議事録のid
            var minutesid = null;
            var messageAllid = null;

            //firebaseの議事録への参照・表記用オブジェクト todo　議事録選択
            var messagesRef　= null;
            var renderMessageobj = null;

            //firebaseの議事録全体への参照・表記用オブジェクト todo 議事録選択
            var messagesAllRef = null;
            var renderMessageAllobj = null;

            //----------------------------------------画面表記用の関数----------------------------------
            // Firebaseの会員から議事録のメ
            // ッセージを取得
            function renderMinutes(uid){
                memberRef = firebase.database().ref('member/'+ uid);
                memberRef.on('value', (snapshot) => {
                    let data = snapshot.val();
                    let result = '';
                    //firebase内の値を取ってきて表示
                    //console.log(data);
                    let keys = Object.keys(data);
                    //console.log(keys);
                    for (let i = 0; i < keys.length; i++) {
                        //todo
                        let minutes = data[keys[i]];
                        //console.log(keys[i]);
                        result += '<li>' + minutes.month + '/' + minutes.day + '/' + minutes.title + '<br>'
                            + '<button class = "select_button" value="' + keys[i] + '"> 議事録を選択する</button></li>'

                        if (result != null) {
                            //この判定を省略するとエラーを吐くので注意
                            document.querySelector('#list').innerHTML = result;

                            const selectButton = document.querySelectorAll('.select_button');
                            for(let btn of selectButton){
                                btn.addEventListener('click',function(event){
                                    console.log(event.currentTarget.value);
                                    var minutesid = event.currentTarget.value;
                                    var messagesPath　= "messages/" + uid + '/' + minutesid;
                                    //console.log(messagesPath);
                                    renderMessageobj = renderMessage(messagesPath);

                                    //firebaseの議事録Allへの参照 todo この処理を別の部分でも書く
                                    var messagesAllPath　= "messagesAll/" + uid + '/' + minutesid;

                                    //初期化表記でバグるので一度空の値を入れている
                                    messagesAllRef = firebase.database().ref(messagesAllPath);
                                });
                            }
                        } else {
                            document.querySelector('#list').innerHTML = "議事録はありません";
                        }
                    }

                })


            };

            function renderMessage(minutespass){
                //console.log(messagesRef);

                //結果を表示として追加
                // Firebaseの既存メッセージを表示
                //DBへのアクセスを取得
                messagesRef = firebase.database().ref(minutespass);
                //console.log(messageRef);
                messagesRef.on('value', (snapshot) => {
                    let data = snapshot.val();
                    //console.log(data)
                    let result = '';
                    //wait...を消去する処理
                    document.querySelector('#div1').innerHTML = "";
                    //firebase内の値を取ってきて表示
                    for (let i in data) {
                        console.log(i);
                        let message = data[i];
                        result += message.minutes + '<br>';
                        document.querySelector('#div1').innerHTML = result;
                    }
                    console.log(result);
                })
            };

            function renderMessageAll(minutesAllPass){
                //todo

                // Firebaseの既存メッセージを表示
                //DBへのアクセスを取得
                messagesAllRef = firebase.database().ref(minutesAllPass);
                messagesAllRef.on('value', (snapshot) => {
                    let data = snapshot.val();
                    let result = data.minutesAll;

                    // console.log(result);
                    document.querySelector('#div3').value = result;
                })
            };


            //----------------------------------logout用関数-----------------------------------
            function logout(){
                firebase.auth().onAuthStateChanged((user) => {
                    firebase.auth().signOut().then(() => {
                        console.log("ログアウトしました");
                        window.location.href = 'lp_proto.html';
                    }).catch((error) => {
                        console.log(`ログアウト時にエラーが発生しました (${error})`);
                    });
                });
            }
            //-----------------------------------firebase初期化--------------------------------------
            //Iinitialize Firebase
            var firebaseConfig = {
                apiKey: "AIzaSyApupTZW_6WvuTnf7b3o9AeOgxv4Nsbpuk",
                authDomain: "gtb-team5.firebaseapp.com",
                databaseURL: "https://gtb-team5.firebaseio.com",
                projectId: "gtb-team5",
                storageBucket: "gtb-team5.appspot.com",
                messagingSenderId: "663345784773",
                appId: "1:663345784773:web:9855dd622cd52158"
            }

            // Initialize Firebase
            try{
                firebase.initializeApp(firebaseConfig);
            }catch (e) {
                console.log(e);
            }
            //----------------------------------ユーザーのidを取得してそこから議事録を表示--------------------
            //ユーザーが持つ議事録一覧を表示
            firebase.auth().onAuthStateChanged(function(user) {
                //ここは非同期処理なので注意。renderMinutes関数はこの場所で呼ぶこと
                if (user) {
                    uid = user.uid;
                    //議事録一覧
                    renderMinutes(uid);

                } else {
                    //ログインしてない時はlpに戻ってもらう
                    window.location.href = 'lp_proto.html';
                }
            })
        </script>
    </head>
        <p>GIJIGORIのメインページだよ！</p>
        <button type="button" onclick="logout();">ログアウト</button>
        <!--todo  onoffによって議事録の切り替えを行う -->
        <button id="start_button">議事録作成開始だよ！</button>
        <button id="save_button">保存ボタンだよ！</button>

        <div id="content"></div>

        <textarea id="div3" name="area" rows="4" cols="40"></textarea>

        <br>
        <div id="div1"></div>


        <ol id="list"></ol>


        <script>
            //--------------------------------------音声認識の処理に関する部分-------------------------------
            //音声認識の準備・日本語の使用を宣言
            const speechRecognition = new webkitSpeechRecognition();
            speechRecognition.lang = 'ja-JP';

            //DOM操作用のオブジェクトを用意
            const startButton = document.getElementById('start_button');
            const content = document.getElementById('content');

            startButton.addEventListener('click', function () {
                //音声認識スタート
                speechRecognition.start();

                //議事録が設定されてない場合作成
                if(minutesid == null && messagesRef == null){
                    //DBに新しい議事録を追加
                    var now   = new Date();
                    var month = now.getMonth();    //月
                    var day   = now.getDate();     //日

                    //todo タイトルの変更
                    //console.log(memberRef);
                    minutesid = memberRef.push({
                        title: "ギジゴリ",
                        month: month,
                        day  : day
                    }).key;

                    //firebaseの議事録への参照 todo この処理を別の部分でも書く
                    var messagesPath　= "messages/" + uid + '/' + minutesid;
                    renderMessageobj = renderMessage(messagesPath);

                    //firebaseの議事録Allへの参照 todo この処理を別の部分でも書く
                    var messagesAllPath　= "messagesAll/" + uid + '/' + minutesid;

                    //初期化表記でバグるので一度空の値を入れている
                    messagesAllRef = firebase.database().ref(messagesAllPath);
                    //todo この下をコメントアウトするとヌルポが出てバグるので注意・・・
                    var text = null;
                    text = document.querySelector('#div3').value;
                    messagesAllRef.set({'minutesAll':text});
                    renderMessageAllobj = renderMessageAll(messagesAllPath);
                }
            });

            speechRecognition.addEventListener('result', function (e) {
                //音声認識で取得した情報を,HTMLに表示する処理
                const text = e.results[0][0].transcript;
                content.innerText = text;
                //Firebaseへのデータの書き込み
                messagesRef.push({
                    minutes: text
                });
            });


            //保存ボタンの処理
            const saveButton = document.getElementById('save_button');
            saveButton.addEventListener('click', function () {
                var text = null;
                text = document.querySelector('#div3').value;
                messagesAllRef.set({'minutesAll':text});
            });


        </script>


    </body>
</html>