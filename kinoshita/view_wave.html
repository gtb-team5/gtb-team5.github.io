<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>canvasで図形を描く</title>
    </head>
    <body>
        <canvas id="sample1" style="background-color:yellow;">
            図形を表示するには、canvasタグをサポートしたブラウザが必要です。
        </canvas>

        <script>
            <!--function sample() { -->
            //描画コンテキストの取得
            var canvas = document.getElementById('sample1');
            console.log(canvas);
            var drawContext = canvas.getContext('2d');

            navigator.mediaDevices.getUserMedia({
                audio: true,
                video: false
            }).then(stream => {
                const audioContext = new AudioContext();
                const sourceNode = audioContext.createMediaStreamSource(stream);
                const analyserNode = audioContext.createAnalyser();
                analyserNode.fftSize = 2048;
                sourceNode.connect(analyserNode);

                function draw() {
                    const barWidth = canvas.width / analyserNode.fftSize;
                    const array = new Uint8Array(analyserNode.fftSize);
                    analyserNode.getByteTimeDomainData(array);
                    drawContext.fillStyle = 'rgba(0, 0, 0, 1)';
                    drawContext.fillRect(0, 0, canvas.width, canvas.height);

                    for (let i = 0; i < analyserNode.fftSize; ++i) {
                        const value = array[i];
                        const percent = value / 255;
                        const height = canvas.height * percent;
                        const offset = canvas.height - height;

                        drawContext.fillStyle = 'lime';
                        drawContext.fillRect(i * barWidth, offset, barWidth, 2);
                    }

                    requestAnimationFrame(draw);
                }

                draw();
            });

        </script>
    </body>
<html>
